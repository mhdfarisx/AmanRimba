<!doctype html>
<html>

<head>
    <meta charset="utf-8" />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
    <script src="//static.redsift.io/reusable/d3-rs-squares/latest/d3-rs-squares.umd-es2015.min.js"></script>

</head>

<body>



    <div class="btn"></div>
    <div class="table"></div>
    <!-- <div id='chart'></div> -->
    <div class="viz"></div>
    <div id="div_tooltip"></div>


    <style>
        * {
            background-color: white;
        }

        html,
        body,
        svg {
            font-family: "Helvetica Neue", -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: bold;
            background-color: white;
        }

        rect {
            fill: '#ccc'
        }
    </style>

    <script>

        let comma = d3.format(',');
        // purchasing item (history)
        d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTffQfPpRShIyvFdnyftjHL8fkREFjrqmLwNs4nvPcjOSzd6Eb3WpIL94TN4seHq4aKqDLa2rFIoJoB/pub?gid=1067828966&single=true&output=csv')
            .then(csv1 => {

                //fields = csv.columns;
                item_dataset = csv1;


                d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTffQfPpRShIyvFdnyftjHL8fkREFjrqmLwNs4nvPcjOSzd6Eb3WpIL94TN4seHq4aKqDLa2rFIoJoB/pub?gid=514510437&single=true&output=csv')
                    .then(csv2 => {


                        booking_dataset = csv2;



                        booking_dataset.forEach((d, i) => {

                            checkIn = d.CheckInDate
                            checkOut = d.CheckOutDate

                            startYear = checkIn.substring(0, 4)
                            startMonth = checkIn.substring(7, 5)
                            startDay = checkIn.substring(10, 8)
                            endYear = checkOut.substring(0, 4)
                            endMonth = checkOut.substring(7, 5)
                            endDay = checkOut.substring(10, 8)

                            d.rangeDate = [
                                d3.timeDays(new Date(startYear, startMonth - 1, startDay), new Date(endYear, endMonth - 1, endDay))

                            ];
                        })

                        console.log('item_dataset', item_dataset)
                        console.log('booking_dataset', booking_dataset)


                        console.log(d3.timeDays(new Date(2020, 1 - 1, 30), new Date(2020, 1 - 1, 32)))
                        calendar()

                    });
            });

        function calendar() {

            //color: '#' + Math.floor(Math.random() * 16777215).toString(16) //randomizae color

            // let _activeYears = d3.select('.selectors-years').selectAll('button')
            //     .filter(d => d.active)
            //     .data()
            //     .map(d => d.key);

            let years = []

            booking_dataset.forEach((d, i) => {

                checkIn = d.CheckInDate
                checkOut = d.CheckOutDate

                startYear = checkIn.substring(0, 4)
                endYear = checkOut.substring(0, 4)

                if (!years.includes(startYear)) {
                    years.push(startYear)
                }
                if (!years.includes(endYear)) {
                    years.push(endYear)
                }

            })

            var data = item_dataset.filter(d => d.Category == 'Gas/Coal')
            // var data = item_dataset.filter(d => d.Category == 'Meal/Catering')
            var data = item_dataset.filter(d => d.Category == 'Hardware')



            cellSize = 20
            width = 1200
            height = 200


            groupCategory = d3.groups(data, d => d['Category']).map(d => {
                return {
                    category: d[0],
                    //value: d[1]
                    value: d3.groups(d[1], d => d['.']).map(d1 => {
                        return {
                            year: d1[0],
                            value: d3.groups(d1[1], d => d['Date']).map(d2 => {
                                return {
                                    date: d2[0],
                                    value: d2[1]
                                }
                            })
                        }
                    })
                }
            })

            console.log(groupCategory)

            const formatTime = d3.timeFormat("%Y-%m-%d")


            var newData = booking_dataset.filter(d => d.GuestName == 'Mr Wong')
            console.log(newData)

            // newData.forEach((d, i) => {

            //     var val = d.rangeDate

            //     val.forEach((k, l) => {

            //         k.forEach((k2, i2) => {

            //             console.log('before', k)
            //             k.push(k2)
            //             console.log('after', k)
            //         })
            //     })
            // })



            function pathMonth(t0) {
                var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
                    d0 = t0.getDay(), w0 = d3.timeWeek.count(d3.timeYear(t0), t0),
                    d1 = t1.getDay(), w1 = d3.timeWeek.count(d3.timeYear(t1), t1);


                return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
                    + "H" + w0 * cellSize + "V" + 7 * cellSize
                    + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
                    + "H" + (w1 + 1) * cellSize + "V" + 0
                    + "H" + (w0 + 1) * cellSize + "Z";
            }

            function detect(dataset, date) {

                let data = []

                dataset.forEach((d, i) => {

                    var arr = d.rangeDate

                    arr.forEach((k, l) => {

                        k.forEach((k2, i2) => {

                            if (formatTime(k2) == formatTime(date)) {
                                if (data != d) {
                                    data.push(d)
                                }

                            }
                            else if (d.CheckOutDate == formatTime(date)) {
                                if (data.length == 0) {
                                    data.push(d)
                                }
                            }

                        })
                    })
                })



                return data
            }

            console.log(groupCategory)


            d3.select('.viz')
                .selectAll('.categories')
                .data(groupCategory, d => d.category)
                .join('div')
                .attr('class', 'categories')
                .call(sel => {

                    sel.selectAll('.title')
                        .data(d => [d])
                        .join('div')
                        .attr('class', 'title')
                        .attr('class', 'title bp3-text-large')
                        .style('margin-top', '24px')
                        .style('margin-bottom', '12x')
                        .style('text-align', 'center')
                        .style('background', '#006600')
                        .style('color', '#fff')
                        .style('padding', '6px')
                        .html(d => d.category.toUpperCase())

                    
                    sel.selectAll('.container')
                        .data(d=>[d])
                        .join('div')
                        .attr('class', 'container')
                    
                        .style('margin', 0)
                        .style('margin-top', '24px')
                        .style('margin-bottom', '12x')
                       
                        // .style('display', 'flex')
                        // .style('flex-wrap', 'wrap')
                        .call(sel => {

                              
                            sel.selectAll('.items')
                                .data(d => [d])
                                .join('div')
                                .attr('class', 'items')
                                .style('display', 'flex')
                                .style('flex-wrap', 'wrap')
                               // .style('justify-content', 'center')
                                .call(sel => {



                                    sel.selectAll('.calendars')
                                        .data(function (d) {

                                            // this code is to add 2022 manually because the item dataset has no year 2022
                                            //therefore it cannot display the year 2022 and also booking with 2022 cannot be displayed
                                            let value = d.value

                                            years.forEach((d, i) => {

                                                for (d in value) {

                                                    console.log('test')
                                                }
                                            })

                                            // value.forEach((d,i)=>{

                                            //     years.forEach((k,l)=>{

                                            //         console.log(years)
                                            //         console.log(k)
                                            //         console.log(!years.includes(k))

                                            //         if (d.year != k && !years.includes(k)) {
                                            //             value.unshift({ year: k, value: [] })
                                            //         }
                                            //     })
                                            // })
                                            return value.sort((a, b) => d3.descending(a.year, b.year))
                                        })
                                        .join('div')

                                        .style('flex', '1 1 100%')
                                        .attr('class', 'calendars')

                                        .call(sel => {



                                            sel.selectAll('.calendar')
                                                .data(d => [d])
                                                .join('svg')
                                                .attr('viewBox', [0,0,width,height].join(' '))
                                                .attr("transform", "translate(30," + 0 + ")")
                                                .attr('class', 'calendar')
                                               

                                                .call(sel => {

                                                    sel.selectAll('.label-year')
                                                        .data(d => [d])
                                                        .join('text')
                                                        .attr('class', 'label-year')
                                                        //.attr("transform", "translate(10," + (cellSize) + ")rotate(-90)") //rotate
                                                        .attr("transform", "translate(20," + (height / 2 - 10) + ")rotate(-90)")
                                                        .attr("font-family", "sans-serif")
                                                        .attr("font-size", 25)
                                                        .attr("text-anchor", "middle")
                                                        .text(function (d) { return d.year; })

                                                    formatDay = i => "SMTWTFS"[i], // given a day number in [0, 6], the day-of-week label

                                                        sel.selectAll('.label-day')
                                                            .data(d3.range(7))
                                                            .join('text')
                                                            .attr('class', 'label-day')
                                                            .attr('transform', d => 'translate(' + [32, d * cellSize + 7 + 33] + ')')
                                                            .attr("font-family", "sans-serif")
                                                            .attr("font-size", 10)
                                                            .attr("text-anchor", "middle")
                                                            .html(formatDay)



                                                    sel.selectAll('.days')
                                                        .data(d => [d])
                                                        .join('svg')
                                                        .attr('class', 'days')
                                                        .call(sel => {

                                                            sel.selectAll('.day')
                                                                .data(function (d) {
                                                                    let daterange = d3.timeDays(new Date(+d.year, 0, 1), new Date(+d.year + 1, 0, 1))
                                                                        .map(k => {

                                                                            return {
                                                                                date: k,
                                                                                values: d.value.filter(p => p.date == formatTime(k)),
                                                                                booking: detect(booking_dataset, k)
                                                                                //staff: 
                                                                            }
                                                                        })

                                                                    return daterange
                                                                })
                                                                .join('svg')
                                                                .attr('class', 'day')
                                                                .call(sel => {

                                                                    sel.selectAll('day-rect')
                                                                        .data(d => [d])
                                                                        .join('rect')
                                                                        .attr('class', 'day-rect')
                                                                        // .html(d=>console.log(d.date))
                                                                        .attr('fill', function (k) {

                                                                            if (k.values && k.values.length) {
                                                                                return '#8FDDE7'
                                                                            }

                                                                            else if (k.date.getMonth() % 2 == 0) {
                                                                                return '#D3D3D3'
                                                                            }

                                                                            else {
                                                                                return '#EBEBE8'
                                                                            }

                                                                        })
                                                                        .attr("width", cellSize)
                                                                        .attr("height", cellSize)
                                                                        // .style('fill', '#ccc')
                                                                        .attr("stroke", "white")
                                                                        .attr("x", function (d) {
                                                                            return 45 + d3.timeWeek.count(d3.timeYear(d.date), d.date) * cellSize;
                                                                        })
                                                                        .attr("y", function (d) { return 25 + d.date.getDay() * cellSize; })
                                                                        .style('padding', 10)

                                                                    sel.selectAll('day-circle')
                                                                        .data(function (k) {

                                                                            if (k.booking && k.booking.length) {
                                                                                // console.log('test')
                                                                                return [k]
                                                                            }
                                                                            else {
                                                                                return []
                                                                            }
                                                                        })
                                                                        .join('circle')
                                                                        .attr('class', 'day-circle')
                                                                        // .html(d=>console.log(d.date))
                                                                        .attr('fill', function (k) {

                                                                            var booking = k.booking
                                                                            var color = []

                                                                            booking.forEach((d, i) => {

                                                                                //    console.log(d)
                                                                                if (k.booking && k.booking.length && d.Events == 'Internal') {
                                                                                    if (color.length == 0) {
                                                                                        color.push('#9D0F40')
                                                                                    }
                                                                                }
                                                                                else {
                                                                                    if (color.length == 0) {
                                                                                        color.push('#81B622')
                                                                                    }
                                                                                }
                                                                            })


                                                                            return color


                                                                        })
                                                                        .attr("width", cellSize - 10)
                                                                        .attr("height", cellSize - 10)

                                                                        .style('r', 5)
                                                                        .attr("stroke", "white")
                                                                        .attr("cx", function (d) {
                                                                            if (d.booking && d.booking.length)
                                                                                return 55 + d3.timeWeek.count(d3.timeYear(d.date), d.date) * cellSize;
                                                                        })
                                                                        .attr("cy", function (d) {
                                                                            if (d.booking && d.booking.length)
                                                                                return 35 + d.date.getDay() * cellSize;
                                                                        })
                                                                        .style('padding', 10)


                                                                })




                                                            sel.selectAll('.path-month')
                                                                .data(function (d) { return d3.timeMonths(new Date(+d.year, 0, 1), new Date(+d.year + 1, 0, 1)); })
                                                                .join('path')
                                                                .attr('class', 'path-month')
                                                                .attr("transform", "translate(45," + 25 + ")")
                                                                .attr("fill", "none")
                                                                .attr("stroke", "black")
                                                                .attr("stroke-width", 1)
                                                                .attr("d", pathMonth)


                                                            sel.selectAll('label')
                                                                .data(function (d) { return d3.timeMonths(new Date(+d.year, 0, 1), new Date(+d.year + 1, 0, 1)); })
                                                                .join('text')
                                                                .attr('class', 'label')
                                                                .attr('transform', d => 'translate(' + [d.getMonth() * cellSize * 5 + 7 + 80, 15] + ')')
                                                                .text(d => 'Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec'.split(',')[d.getMonth()])


                                                        })
                                                })
                                        })

                                        sel.selectAll('.data-viz')
                                            .data(d=>[d])
                                            .join('svg')
                                            .attr('class', 'data-viz')
                                            .style('flex', '1 1 10%')
                                            .attr('viewBox', [0,0,width,500].join(' '))
                                            .call(sel=>{

                                                // sel.selectAll('.bubble-charts')
                                                //     .data(function(d){

                                                //         let filterData = item_dataset.filter(k=>k.Category == d.category)

                                                //         let group = d3.groups(filterData, k=> k['.']).map(d=>{
                                                //                     return {

                                                //                         year: d[0],
                                                //                         value: d[1],
                                                //                         total: d3.sum(d[1], d=> d.TotalPrice)

                                                //                     }
                                                //                 })
                                                            
                                                //             group.forEach((d,i)=>{

                                                //                 d.y = i
                                                //             })

                                                //                 return group
                                                //     })
                                                //     .join('g')
                                                //     .attr('class', 'bubble-charts')
                                                //     .attr('transform', d => 'translate(' + [32, d.y * (cellSize + 5)+ 50] + ')')
                                                //     .call(sel=>{

                                                //         sel.selectAll('.bar-year')
                                                //             .data(d=>[d])
                                                //             .join('text')
                                                //             .attr('class', 'bar-year')
                                                //             .attr('text-anchor', 'left')
                                                //             .attr('x', 0)
                                                //             .attr('y', 15)
                                                //             .attr('font-size', '15px')
                                                //             .html(d=> d.year)

                                                //         sel.selectAll('.barchart-year')
                                                //             .data(d=>[d])
                                                //             .join('rect')
                                                //             .attr('class', 'barchart-year')
                                                //             .attr("transform", "translate(" + 35 + "," + 0 + ")")
                                                //             .attr('width', d=>d.total/40)
                                                //             .attr('height', 20)
                                                //             .attr('stroke', 'black')
                                                //             .attr('fill', 'blue')
                                                //             .style("opacity", 0.7)
                                                //             .html(d=>console.log(d))

                                                //         sel.selectAll('.bubble-value')
                                                //             .data(d=>[d])
                                                //             .join('text')
                                                //             .attr('class', 'bubble-value')
                                                //             .attr('x', d=>d.total/40 + 40)
                                                //             .attr('y', 15)
                                                //             .html(d=> 'RM' + comma(d.total))
                                                        
                                                      
                                                //     })

                                                sel.selectAll('.bubble-charts')
                                                    .data(function(d){

                                                        let filterData = item_dataset.filter(k=>k.Category == d.category)

                                                        let group = d3.groups(filterData, k=> k['.']).map(d=>{
                                                                    return {

                                                                        year: d[0],
                                                                        value: d[1],
                                                                        total: d3.sum(d[1], d=> d.TotalPrice)

                                                                    }
                                                                })
                                                            
                                                            group.forEach((d,i)=>{

                                                                d.y = i
                                                            })

                                                                return group
                                                    })
                                                    .join('g')
                                                    .attr('class', 'bubble-charts')
                                                    .attr('transform', d => 'translate(' + [32, d.y * (cellSize + 25)+ 50] + ')')
                                                    .call(sel=>{

                                                        sel.selectAll('.bar-year')
                                                            .data(d=>[d])
                                                            .join('text')
                                                            .attr('class', 'bar-year')
                                                            .attr('text-anchor', 'left')
                                                            .attr('x', 0)
                                                            .attr('y', 15)
                                                            .attr('font-size', '15px')
                                                            .html(d=> d.year)

                                                        sel.selectAll('.barchart-year')
                                                            .data(d=>[d])
                                                            .join('circle')
                                                            .attr('class', 'barchart-year')
                                                            .attr("transform", "translate(" + 35 + "," + 10 + ")")
                                                          
                                                            .attr('r', function(d){

                                                               return 10
                                                            })
                                                            .attr('stroke', 'black')
                                                            .attr('fill', 'blue')
                                                            .style("opacity", 0.7)
                                                            .html(d=>console.log(d))

                                                        sel.selectAll('.bubble-value')
                                                            .data(d=>[d])
                                                            .join('text')
                                                            .attr('class', 'bubble-value')
                                                            .attr('x', d=>d.total/40 + 40)
                                                            .attr('y', 15)
                                                            .html(d=> 'RM' + comma(d.total))
                                                        
                                                      
                                                    })
                                                    

                                                sel.selectAll('.piecharts')
                                                    .data(function(d){

                                                        let filterData = item_dataset.filter(k=>k.Category == d.category)

                                                        let group = d3.groups(filterData, k=> k['Item']).map(d=>{
                                                                    return {

                                                                        year: d[0],
                                                                        value: d[1],
                                                                        total: d3.sum(d[1], d=> d.TotalPrice)

                                                                    }
                                                                })
                                                            
                                                            group.forEach((d,i)=>{

                                                                d.y = i
                                                            })

                                                                return group
                                                        })
                                                    .join('path')
                                                    .attr('class', 'piecharts')
                                                
                                            })




                                })

                        })

                })
        }




    </script>
</body>

</html>